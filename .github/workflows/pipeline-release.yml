name: Proxy-Release

on:
  workflow_dispatch:
    inputs:
      version: 
        description: 'Release version (x.x.x)'
        required: true
        default: '0.0.0'

jobs:
  run-bvt-gcc11:
    uses: ./.github/workflows/bvt-gcc11.yml
    name: run bvt with g++ 11

  prepare-release:
    runs-on: windows-latest
    needs: [run-bvt-gcc11]
    steps:
    - uses: actions/checkout@v3
    
    - name: create zip archive
      run: Compress-Archive -Path ".\proxy.h" -DestinationPath ".\proxy-${{ github.event.inputs.version }}.zip"

    - name: create release branch
      run: |
        git checkout -b release/${{ github.event.inputs.version }}

    - name: assign cmake version
      uses: jacobtomlinson/gha-find-replace@v2
      with:
        find: 'VERSION [0-9].[0-9].[0-9]'
        replace: 'VERSION ${{ github.event.inputs.version }}'
        regex: false
        include: CMakeLists.txt

    - name: commit changes
      run: |
        git add CMakeLists.txt
        git commit -m 'assign a release version'

    - name: new git tag
      run: |
        git tag ${{ github.event.inputs.version }}

    - name: push git objects
      run: |
        git push origin release/${{ github.event.inputs.version }}
        git push origin ${{ github.event.inputs.version }}
          
    - uses: actions/create-release@v1
      name: create release draft
      id: release_draft
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version }}
        release_name: Proxy ${{ github.event.inputs.version }} Release
        draft: true
        prerelease: true

    - name: upload artifacts
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.release_draft.outputs.upload_url }}
        asset_path: ./proxy-${{ github.event.inputs.version }}.zip
        asset_name: proxy-${{ github.event.inputs.version }}.zip
        asset_content_type: application/zip
