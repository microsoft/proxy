on:
  workflow_call:

jobs:
  bvt-compatibility:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        compiler:
          - {compiler: gcc, version: 13, modules: false}
          - {compiler: gcc, version: 14, modules: true}
          - {compiler: clang, version: 16, modules: false}
          - {compiler: clang, version: 17, modules: false}
          - {compiler: clang, version: 18, modules: false}
          - {compiler: clang, version: 19, modules: false}
          - {compiler: clang, version: 20, modules: true}
        buildsystem: [cmake, meson]

    steps:
    - uses: actions/checkout@v4

    - name: install meson
      if: ${{ matrix.buildsystem == 'meson' }}
      run: pipx install meson

    - name: install gcc
      if: ${{ matrix.compiler.compiler == 'gcc' }}
      run: |
        sudo apt install -y 'g++-${{ matrix.compiler.version }}'
        cat <<'EOF' >> "$GITHUB_ENV"
        CC=gcc-${{ matrix.compiler.version }}
        CXX=g++-${{ matrix.compiler.version }}
        EOF

    - name: install clang
      if: ${{ matrix.compiler.compiler == 'clang' }}
      run: |
        sudo apt install -y 'clang-${{ matrix.compiler.version }}' 'clang-tools-${{ matrix.compiler.version }}' 'libc++-${{ matrix.compiler.version }}-dev' 'libc++abi-${{ matrix.compiler.version }}-dev'
        cat <<'EOF' >> "$GITHUB_ENV"
        CC=clang-${{ matrix.compiler.version }}
        CXX=clang++-${{ matrix.compiler.version }}
        CXXFLAGS=-stdlib=libc++
        EOF

    - name: check compiler version
      run: |
        "$CXX" --version

    - name: build and run test with cmake
      if: ${{ matrix.buildsystem == 'cmake' }}
      run: |
        cmake -B build -GNinja -DCMAKE_BUILD_TYPE=Release '-DPROXY_BUILD_MODULES=${{ matrix.compiler.modules }}'
        cmake --build build -j
        ctest --test-dir build -j

    - name: build and run test with meson
      if: ${{ matrix.buildsystem == 'meson' }}
      run: |
        meson setup build --buildtype=release -Dmodules=${{ matrix.compiler.modules && 'auto' || 'disabled' }}
        meson test -C build
