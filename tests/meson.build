tests_exe = executable(
  'msft_proxy_tests',
  files(
    'proxy_creation_tests.cpp',
    'proxy_dispatch_tests.cpp',
    'proxy_fmt_format_tests.cpp',
    'proxy_format_tests.cpp',
    'proxy_integration_tests.cpp',
    'proxy_invocation_tests.cpp',
    'proxy_lifetime_tests.cpp',
    'proxy_reflection_tests.cpp',
    'proxy_regression_tests.cpp',
    'proxy_rtti_tests.cpp',
    'proxy_traits_tests.cpp',
    'proxy_view_tests.cpp',
  ),
  implicit_include_directories: false,
  dependencies: [msft_proxy4_dep, gtest_dep, fmt_dep],
  build_by_default: false,
)

autogen_tests = custom_target(
  command: [
    autogen_tests_exe,
    custom_target(
      command: [tests_exe, '--gtest_list_tests', '--gtest_output=json:@OUTPUT@'],
      output: 'tests.json',
    ),
    meson.current_source_dir() / 'meson.build',
  ],
  output: 'autogen.stamp',
  build_by_default: true,
)

#pragma autogen push
tests = {
  'ProxyCreationTests': [
    'TestMakeProxyInplace_FromValue',
    'TestMakeProxyInplace_InPlace',
    'TestMakeProxyInplace_InPlaceInitializerList',
    'TestMakeProxyInplace_Lifetime_Copy',
    'TestMakeProxyInplace_Lifetime_Move',
    'TestAllocateProxy_DirectAllocator_FromValue',
    'TestAllocateProxy_DirectAllocator_InPlace',
    'TestAllocateProxy_DirectAllocator_InPlaceInitializerList',
    'TestAllocateProxy_DirectAllocator_Lifetime_Copy',
    'TestAllocateProxy_DirectAllocator_Lifetime_Move',
    'TestAllocateProxy_IndirectAllocator_FromValue',
    'TestAllocateProxy_IndirectAllocator_InPlace',
    'TestAllocateProxy_IndirectAllocator_InPlaceInitializerList',
    'TestAllocateProxy_IndirectAllocator_Lifetime_Copy',
    'TestAllocateProxy_IndirectAllocator_Lifetime_Move',
    'TestMakeProxy_WithSBO_FromValue',
    'TestMakeProxy_WithSBO_InPlace',
    'TestMakeProxy_WithSBO_InPlaceInitializerList',
    'TestMakeProxy_WithSBO_Lifetime_Copy',
    'TestMakeProxy_WithSBO_Lifetime_Move',
    'TestMakeProxy_WithoutSBO_FromValue',
    'TestMakeProxy_WithoutSBO_InPlace',
    'TestMakeProxy_WithoutSBO_InPlaceInitializerList',
    'TestMakeProxy_WithoutSBO_Lifetime_Copy',
    'TestMakeProxy_WithoutSBO_Lifetime_Move',
    'TestMakeProxy_SfinaeUnsafe',
    'TestAllocateProxyShared_SharedCompact_FromValue',
    'TestAllocateProxyShared_SharedCompact_InPlace',
    'TestAllocateProxyShared_SharedCompact_InPlaceInitializerList',
    'TestAllocateProxyShared_SharedCompact_Lifetime_Copy',
    'TestAllocateProxyShared_SharedCompact_Lifetime_Move',
    'TestAllocateProxyShared_StrongCompact_FromValue',
    'TestAllocateProxyShared_StrongCompact_InPlace',
    'TestAllocateProxyShared_StrongCompact_InPlaceInitializerList',
    'TestAllocateProxyShared_StrongCompact_Lifetime_Copy',
    'TestAllocateProxyShared_StrongCompact_Lifetime_Move',
    'TestAllocateProxyShared_StrongCompact_Lifetime_WeakAccess',
    'TestMakeProxyShared_SharedCompact_FromValue',
    'TestMakeProxyShared_SharedCompact_InPlace',
    'TestMakeProxyShared_SharedCompact_InPlaceInitializerList',
    'TestMakeProxyShared_SharedCompact_Lifetime_Copy',
    'TestMakeProxyShared_SharedCompact_Lifetime_Move',
    'TestMakeProxyShared_StrongCompact_FromValue',
    'TestMakeProxyShared_StrongCompact_InPlace',
    'TestMakeProxyShared_StrongCompact_InPlaceInitializerList',
    'TestMakeProxyShared_StrongCompact_Lifetime_Copy',
    'TestMakeProxyShared_StrongCompact_Lifetime_Move',
    'TestMakeProxyShared_StrongCompact_Lifetime_WeakAccess',
    'TestMakeProxyShared_StrongCompact_Lifetime_WeakConversion',
    'TestStdWeakPtrCompatibility',
    'TestMakeProxyView',
  ],
  'ProxyDispatchTests': [
    'TestOpPlus',
    'TestOpMinus',
    'TestOpAsterisk',
    'TestOpSlash',
    'TestOpModulo',
    'TestOpIncrement',
    'TestOpDecrement',
    'TestOpEqualTo',
    'TestOpNotEqualTo',
    'TestOpGreaterThan',
    'TestOpLessThan',
    'TestOpGreaterThanOrEqualTo',
    'TestOpLessThanOrEqualTo',
    'TestOpSpaceship',
    'TestOpLogicalNot',
    'TestOpLogicalAnd',
    'TestOpLogicalOr',
    'TestOpTilde',
    'TestOpAmpersand',
    'TestOpPipe',
    'TestOpCaret',
    'TestOpLeftShift',
    'TestOpRightShift',
    'TestOpPlusAssignment',
    'TestOpMinusAssignment',
    'TestOpMultiplicationAssignment',
    'TestOpDivisionAssignment',
    'TestOpModuloAssignment',
    'TestOpBitwiseAndAssignment',
    'TestOpBitwiseOrAssignment',
    'TestOpBitwiseXorAssignment',
    'TestOpLeftShiftAssignment',
    'TestOpRightShiftAssignment',
    'TestOpComma',
    'TestOpPtrToMem',
    'TestOpParentheses',
    'TestOpBrackets_OneDimensional',
    'TestRhsOpPlus',
    'TestRhsOpMinus',
    'TestRhsOpAsterisk',
    'TestRhsOpSlash',
    'TestRhsOpModulo',
    'TestRhsOpEqualTo',
    'TestRhsOpNotEqualTo',
    'TestRhsOpGreaterThan',
    'TestRhsOpLessThan',
    'TestRhsOpGreaterThanOrEqualTo',
    'TestRhsOpLessThanOrEqualTo',
    'TestRhsOpSpaceship',
    'TestRhsOpLogicalAnd',
    'TestRhsOpLogicalOr',
    'TestRhsOpAmpersand',
    'TestRhsOpPipe',
    'TestRhsOpCaret',
    'TestRhsOpLeftShift',
    'TestRhsOpRightShift',
    'TestRhsOpPlusAssignment',
    'TestRhsOpMinusAssignment',
    'TestRhsOpMultiplicationAssignment',
    'TestRhsOpDivisionAssignment',
    'TestRhsOpModuloAssignment',
    'TestRhsOpBitwiseAndAssignment',
    'TestRhsOpBitwiseOrAssignment',
    'TestRhsOpBitwiseXorAssignment',
    'TestRhsOpLeftShiftAssignment',
    'TestRhsOpRightShiftAssignment',
    'TestRhsOpComma',
    'TestRhsOpPtrToMem',
    'TestIndirectConversion',
    'TestDirectConversion',
    'TestImplciitConversion',
    'TestFreeAsMemDispatch',
    'TestSubstitutionDispatch',
  ],
  'ProxyFmtFormatTests': ['TestFormat', 'TestWformat'],
  'ProxyFormatTests': ['TestFormat', 'TestWformat'],
  'ProxyIntegrationTests': ['TestDrawable', 'TestLogger'],
  'ProxyInvocationTests': [
    'TestArgumentForwarding',
    'TestThrow',
    'TestMultipleDispatches_Unique',
    'TestMultipleDispatches_Duplicated',
    'TestRecursiveDefinition',
    'TestOverloadResolution_Member',
    'TestOverloadResolution_Free',
    'TestOverloadResolution_FreeAsMem',
    'TestNoexcept',
    'TestFunctionPointer',
    'TestMemberDispatchDefault',
    'TestFreeDispatchDefault',
    'TestObserverDispatch',
    'TestQualifiedConvention_Member',
    'TestQualifiedConvention_Free',
  ],
  'ProxyLifetimeTests': [
    'TestDefaultConstrction',
    'TestNullConstrction_Nullptr',
    'TestNullConstrction_TypedNullPointer',
    'TestPolyConstrction_FromValue',
    'TestPolyConstrction_FromValue_Exception',
    'TestPolyConstrction_InPlace',
    'TestPolyConstrction_InPlace_Exception',
    'TestPolyConstrction_InPlaceInitializerList',
    'TestPolyConstrction_InPlaceInitializerList_Exception',
    'TestCopyConstrction_FromValue',
    'TestCopyConstrction_FromValue_Exception',
    'TestCopyConstrction_FromNull',
    'TestMoveConstrction_FromValue',
    'TestMoveConstrction_FromValue_Trivial',
    'TestMoveConstrction_FromNull',
    'TestNullAssignment_FromNullptr_ToValue',
    'TestNullAssignment_FromTypedNullPointer_ToValue',
    'TestNullAssignment_ToNull',
    'TestPolyAssignment_ToValue',
    'TestPolyAssignment_ToValue_Exception',
    'TestPolyAssignment_FromValue_ToNull',
    'TestPolyAssignment_FromValue_ToNull_Exception',
    'TestPolyAssignment_InPlace_ToValue',
    'TestPolyAssignment_InPlace_ToValue_Exception',
    'TestPolyAssignment_InPlace_ToNull',
    'TestPolyAssignment_InPlace_ToNull_Exception',
    'TestPolyAssignment_InPlaceInitializerList_ToValue',
    'TestPolyAssignment_InPlaceInitializerList_ToValue_Exception',
    'TestPolyAssignment_InPlaceInitializerList_ToNull',
    'TestPolyAssignment_InPlaceInitializerList_ToNull_Exception',
    'TestCopyAssignment_FromValue_ToValue',
    'TestCopyAssignment_FromValue_ToValue_Exception',
    'TestCopyAssignment_FromValue_ToSelf',
    'TestCopyAssignment_FromValue_ToNull',
    'TestCopyAssignment_FromValue_ToNull_Exception',
    'TestCopyAssignment_FromNull_ToValue',
    'TestCopyAssignment_FromNull_ToSelf',
    'TestCopyAssignment_FromNull_ToNull',
    'TestMoveAssignment_FromValue_ToValue',
    'TestMoveAssignment_FromValue_ToValue_Exception',
    'TestMoveAssignment_FromValue_ToSelf',
    'TestMoveAssignment_FromValue_ToNull',
    'TestMoveAssignment_FromValue_ToNull_Exception',
    'TestMoveAssignment_FromNull_ToValue',
    'TestMoveAssignment_FromNull_ToSelf',
    'TestMoveAssignment_FromNull_ToNull',
    'TestHasValue',
    'TestOperatorBool',
    'TestEqualsToNullptr',
    'TestReset_FromValue',
    'TestReset_FromNull',
    'TestSwap_Value_Value',
    'TestSwap_Value_Self',
    'TestSwap_Value_Null',
    'TestSwap_Null_Value',
    'TestSwap_Null_Self',
    'TestSwap_Null_Null',
    'TestSwap_Trivial',
    'Test_DirectConvension_Lvalue',
    'Test_DirectConvension_Rvalue',
    'Test_DirectConvension_Rvalue_Exception',
    'Test_CopySubstitution_FromValue',
    'Test_CopySubstitution_FromNull',
    'Test_MoveSubstitution_FromValue',
    'Test_MoveSubstitution_FromNull',
  ],
  'ProxyReflectionTests': [
    'TestRtti_RawPtr',
    'TestRtti_FancyPtr',
    'TestTraits_RawPtr',
    'TestTraits_FancyPtr',
  ],
  'ProxyRegressionTests': [
    'TestUnexpectedCompilerWarning',
    'TestProxiableSelfDependency',
  ],
  'ProxyRttiTests': [
    'TestIndirectCast_Ref_Succeed',
    'TestIndirectCast_Ref_Fail',
    'TestIndirectCast_ConstRef_Succeed',
    'TestIndirectCast_ConstRef_Fail',
    'TestIndirectCast_Copy_Succeed',
    'TestIndirectCast_Copy_Fail',
    'TestIndirectCast_Move_Succeed',
    'TestIndirectCast_Move_Fail',
    'TestIndirectCast_Ptr_Succeed',
    'TestIndirectCast_Ptr_Fail',
    'TestIndirectCast_ConstPtr_Succeed',
    'TestIndirectCast_ConstPtr_Fail',
    'TestIndirectTypeid',
    'TestDirectCast_Ref_Succeed',
    'TestDirectCast_Ref_Fail',
    'TestDirectCast_ConstRef_Succeed',
    'TestDirectCast_ConstRef_Fail',
    'TestDirectCast_Copy_Succeed',
    'TestDirectCast_Copy_Fail',
    'TestDirectCast_Move_Succeed',
    'TestDirectCast_Move_Fail',
    'TestDirectCast_Ptr_Succeed',
    'TestDirectCast_Ptr_Fail',
    'TestDirectCast_ConstPtr_Succeed',
    'TestDirectCast_ConstPtr_Fail',
    'TestDirectTypeid',
  ],
  'ProxyViewTests': [
    'TestViewOfNull',
    'TestViewIndependentUse',
    'TestViewOfOwning',
    'TestViewOfNonOwning',
    'TestOverloadShadowing',
    'TestSubstitution_FromNull',
    'TestSubstitution_FromValue',
    'TestFacadeAware',
  ],
}
#pragma autogen pop

foreach suite : tests.keys()
  foreach name : tests[suite]
    test(
      name,
      tests_exe,
      args: [f'--gtest_filter=@suite@.@name@'],
      protocol: 'gtest',
      suite: suite,
      depends: autogen_tests,
    )
  endforeach
endforeach

freestanding = get_option('tests_freestanding')
freestanding_cflags = ['-ffreestanding', '-fno-exceptions', '-fno-rtti']
freestanding_ldflags = ['-nodefaultlibs']

if cxx.has_multi_arguments(
  freestanding_cflags + freestanding_ldflags,
  required: freestanding,
)
  libc_dep = cxx.find_library(
    'c',
    required: freestanding,
  )
  freestanding_tests_exe = executable(
    'msft_proxy_freestanding_tests',
    files('freestanding/proxy_freestanding_tests.cpp'),
    implicit_include_directories: false,
    dependencies: [msft_proxy4_dep, libc_dep],
    cpp_args: freestanding_cflags,
    link_args: get_option('b_sanitize') == '' ? freestanding_ldflags : [],
    build_by_default: false,
  )
  test(
    'TestFreestanding',
    freestanding_tests_exe,
    suite: 'ProxyFreestandingSupportTests',
  )
endif

subdir(
  'modules',
  if_found: msft_proxy4_mod,
)
